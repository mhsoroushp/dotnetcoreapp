trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageName: 'dotnetcoreapp'
  imageTag: '$(Build.BuildId) latest'

steps:
- checkout: self

- script: |
    set -euo pipefail
    docker version
    docker build -f Dockerfile -t $(imageName):$(imageTag) -t $(imageName):latest .
  displayName: Build Docker image

- script: |
    set -euo pipefail
    docker run -d --rm --name $(imageName)-container -p 8080:8080 $(imageName):$(imageTag)

    echo "Waiting for app to start..."
    for i in {1..30}; do
      if curl -fsS http://localhost:8080/ >/dev/null; then
        echo "Container is healthy."
        break
      fi
      sleep 2
    done

    curl -i http://localhost:8080/
  displayName: Run container and smoke test

- script: |
    set +e
    docker logs $(imageName)-container
    docker stop $(imageName)-container
  displayName: Cleanup container
  condition: always()

- task: Docker@2
  inputs:
    containerRegistry: 'ConDotNetApp'
    repository: 'repoDotNetApp'
    command: 'buildAndPush'
    Dockerfile: './Dockerfile'